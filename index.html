<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>sub5conscious</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --text: #f8fafc;
            --border: #334155; --accent: #3b82f6;
            --p1: #3b82f6; --p2: #ec4899;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* UI Components */
        #header { width: 100%; padding: 10px 0; background: var(--panel); border-bottom: 1px solid var(--border); text-align: center; z-index: 10; }
        .timer-bar { display: flex; justify-content: center; gap: 30px; font-size: 1.8rem; font-weight: 900; font-family: monospace; }
        .p-box { opacity: 0.2; transition: 0.4s; }
        .p-box.active { opacity: 1; color: var(--accent); transform: scale(1.1); }
        #status-msg { font-size: 0.8rem; color: var(--accent); min-height: 1.2em; letter-spacing: 2px; text-transform: uppercase; }

        /* Game Board */
        #board-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        #board { display: grid; grid-template-columns: repeat(8, 1fr); width: 92vw; height: 92vw; max-width: 450px; background: var(--border); gap: 1px; border: 2px solid var(--border); }
        .cell { background: var(--panel); position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .token { width: 80%; height: 80%; border-radius: 50%; transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); transform: scale(0); pointer-events: none; }
        .token.show { transform: scale(1); }
        .token.opened { border: 3px solid #fff; box-shadow: 0 0 15px currentColor; }
        .token.stealth { opacity: 0.25; }

        /* Overlays */
        .overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .section { background: var(--panel); padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; margin-bottom: 15px; border: 1px solid var(--border); }
        button { background: var(--panel); color: var(--text); border: 1px solid var(--border); padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 1rem; }
        button.primary { background: var(--accent); border: none; }
        
        #pass-overlay { background: #000; color: #fff; text-align: center; }
        #top-controls { position: fixed; bottom: 25px; right: 25px; display: flex; gap: 15px; z-index: 2000; }
        .ctrl-btn { width: 55px; height: 55px; background: var(--panel); border: 1px solid var(--border); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.4); font-size: 1.5rem; }

        @keyframes winAnim { 0%,100%{transform:scale(1);} 50%{transform:scale(1.2); filter:brightness(1.3);} }
        .win-token { animation: winAnim 0.6s infinite; z-index: 10; }
    </style>
</head>
<body>

    <div id="header">
        <div id="status-msg">READY</div>
        <div class="timer-bar">
            <div id="p1-ui" class="p-box active">P1 <span id="p1-t">10:00</span></div>
            <div id="p2-ui" class="p-box">P2 <span id="p2-t">10:00</span></div>
        </div>
    </div>

    <div id="board-area"><div id="board"></div></div>

    <div id="menu-overlay" class="overlay" style="display: flex;">
        <h1 style="font-size: 2.8rem; margin-bottom: 40px; letter-spacing: -2px;">sub5conscious</h1>
        <div class="section">
            <button class="primary" onclick="setupGame('offline')">2P OFFLINE</button>
            <button class="primary" onclick="setupGame('ai')">VS LEARNING AI</button>
            <button class="primary" onclick="showOnlineSetup()">ONLINE MATCH</button>
        </div>
        <button onclick="showLogs()" style="opacity:0.6; border:none; font-size:0.8rem;">ANALYTICS & LOG</button>
    </div>

    <div id="pass-overlay" class="overlay">
        <h1 id="pass-player-name">PLAYER 2 TURN</h1>
        <p style="opacity:0.5;">Please pass the device</p>
        <button onclick="resumeFromPass()" style="background:#fff; color:#000; width:220px; margin-top:40px; border-radius:50px;">I RECEIVED IT</button>
    </div>

    <div id="settings-overlay" class="overlay">
        <h2>OPTIONS</h2>
        <div class="section">
            <label style="font-size:0.7rem;">TIMER (MIN / BYOYOMI)</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="number" id="cfg-min" value="10" style="width:50%; padding:10px; background:#0f172a; color:#fff; border:1px solid var(--border);">
                <input type="number" id="cfg-byo" value="30" style="width:50%; padding:10px; background:#0f172a; color:#fff; border:1px solid var(--border);">
            </div>
            <button class="primary" onclick="applySettings()" style="margin-top:15px;">APPLY & RESET</button>
        </div>
        <button onclick="closeOverlays()">CLOSE</button>
    </div>

    <div id="online-overlay" class="overlay">
        <h2>ONLINE CONNECT</h2>
        <div class="section">
            <input type="text" id="match-kw" placeholder="KEYWORD" style="width:100%; padding:15px; background:#0f172a; border:1px solid var(--border); color:#fff; border-radius:8px;">
            <button class="primary" onclick="connectOnline()" style="margin-top:15px;">CONNECT</button>
        </div>
        <button onclick="closeOverlays()">BACK</button>
    </div>

    <div id="top-controls">
        <div class="ctrl-btn" onclick="handleReset()">üîÑ</div>
        <div class="ctrl-btn" onclick="openSettings()">‚â°</div>
    </div>

    <script>
        // --- Core Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyAIkCvmJVZE9qzeAPFTIEijsuZ_HGRiUlA",
            authDomain: "sub5conscious.firebaseapp.com",
            projectId: "sub5conscious",
            databaseURL: "https://sub5conscious-default-rtdb.firebaseio.com",
            storageBucket: "sub5conscious.firebasestorage.app",
            messagingSenderId: "774659474330",
            appId: "1:774659474330:web:d1ff3843a96f6e6001b023"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let SIZE = 8, board = [], currentPlayer = 1, winLine = null, moveHistory = [];
        let p1Time = 600, p2Time = 600, p1Byo = 30, p2Byo = 30, configMin = 10, configByo = 30;
        let timerId = null, mode = 'offline', myId = 1, firstSelect = null, isPassing = false, dbRef = null;
        let learnedData = [];

        // --- Game Logic ---
        async function setupGame(m) {
            mode = m;
            document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
            if(mode === 'ai') await loadAIKnowledge();
            initBoard();
        }

        async function loadAIKnowledge() {
            const snap = await db.ref('game_logs').limitToLast(30).once('value');
            learnedData = [];
            snap.forEach(s => { if(s.val().history) learnedData.push(...s.val().history); });
        }

        function initBoard() {
            clearInterval(timerId);
            board = Array.from({length:SIZE}, () => Array(SIZE).fill(null).map(() => ({p:0, open:false})));
            currentPlayer = 1; winLine = null; firstSelect = null; isPassing = false; moveHistory = [];
            p1Time = configMin * 60; p2Time = p1Time; p1Byo = configByo; p2Byo = configByo;
            
            const grid = document.getElementById('board');
            grid.innerHTML = '';
            for(let r=0; r<SIZE; r++) {
                for(let c=0; c<SIZE; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.onclick = () => handleCellClick(r, c);
                    let t = document.createElement('div'); t.className = 'token';
                    cell.appendChild(t); grid.appendChild(cell);
                }
            }
            startTimer();
            updateUI();
        }

        function handleCellClick(r, c) {
            if(winLine || isPassing || board[r][c].open) return;
            if(mode === 'online' && currentPlayer !== myId) return;

            if(!firstSelect) {
                firstSelect = {r, c};
            } else {
                // „ÄêÊ©üËÉΩ4Ôºö„Ç≠„É£„É≥„Çª„É´Ë™øÊï¥„ÄëÂêå„Åò„Éû„Çπ„ÇíÂè©„ÅÑ„Åü„ÇâËß£Èô§
                if(firstSelect.r === r && firstSelect.c === c) {
                    firstSelect = null;
                } else {
                    let dr = Math.abs(r - firstSelect.r), dc = Math.abs(c - firstSelect.c);
                    if(dr === 0 && dc === 0) commit([{r, c, open: true}]);
                    else if(dr + dc === 1) commit([{r: firstSelect.r, c: firstSelect.c, open: false}, {r, c, open: false}]);
                    else firstSelect = {r, c};
                }
            }
            updateUI();
        }

        function commit(moves) {
            moves.forEach(m => {
                let cell = board[m.r][m.c];
                if(cell.p !== 0 || m.open) cell.open = true;
                cell.p = currentPlayer;
                moveHistory.push({r: m.r, c: m.c, p: currentPlayer});
            });

            if(checkWin(currentPlayer)) {
                endGame(`PLAYER ${currentPlayer} WIN!`);
            } else {
                currentPlayer = (currentPlayer === 1) ? 2 : 1;
                firstSelect = null;
                if(mode === 'offline') {
                    isPassing = true;
                    document.getElementById('pass-overlay').style.display = 'flex';
                    document.getElementById('pass-player-name').innerText = `PLAYER ${currentPlayer} TURN`;
                } else if(mode === 'ai' && currentPlayer === 2) {
                    setTimeout(executeAIMove, 600);
                } else if(mode === 'online') {
                    syncOnline();
                }
            }
            updateUI();
        }

        function executeAIMove() {
            // „ÄêÊ©üËÉΩ5ÔºöÂ≠¶ÁøíÂûãAI„ÄëÈÅéÂéª„Éá„Éº„Çø„Å´Âü∫„Å•„Åç„Çπ„Ç≥„Ç¢„É™„É≥„Ç∞
            let candidates = [];
            for(let r=0; r<SIZE; r++) {
                for(let c=0; c<SIZE; c++) {
                    if(!board[r][c].open) {
                        let weight = learnedData.filter(d => d.r === r && d.c === c).length;
                        candidates.push({r, c, w: weight + Math.random()});
                    }
                }
            }
            candidates.sort((a,b) => b.w - a.w);
            let m1 = candidates[0];
            let m2 = candidates.find(c => Math.abs(c.r-m1.r)+Math.abs(c.r-m1.c) === 1) || candidates[1];
            commit([{r: m1.r, c: m1.c, open:false}, {r: m2.r, c: m2.c, open:false}]);
        }

        function checkWin(p) {
            const dirs = [[1,0],[0,1],[1,1],[1,-1]];
            for(let r=0; r<SIZE; r++) {
                for(let c=0; c<SIZE; c++) {
                    if(board[r][c].p === p && board[r][c].open) {
                        for(let [dr,dc] of dirs) {
                            let line = [];
                            for(let i=0; i<5; i++) {
                                let nr=r+dr*i, nc=c+dc*i;
                                if(nr>=0&&nr<SIZE&&nc>=0&&nc<SIZE&&board[nr][nc].p===p&&board[nr][nc].open) line.push({r:nr,c:nc});
                                else break;
                            }
                            if(line.length === 5) { winLine = line; return true; }
                        }
                    }
                }
            }
            return false;
        }

        function updateUI() {
            const tokens = document.querySelectorAll('.token');
            const cells = document.querySelectorAll('.cell');
            board.flat().forEach((cell, i) => {
                let t = tokens[i];
                t.style.backgroundColor = cell.p === 1 ? 'var(--p1)' : 'var(--p2)';
                let isMe = (mode === 'offline' && !isPassing && cell.p === currentPlayer) || (mode === 'ai' && cell.p === 1) || (mode === 'online' && cell.p === myId);
                
                // „ÄêÊ©üËÉΩ3ÔºöÂÖ®ÂÖ¨Èñã„É™„Éó„É¨„Ç§„ÄëÂãùÂà©ÊôÇ„ÅØÂÖ®Èßí„Ç™„Éº„Éó„É≥
                if(cell.open || winLine) t.className = 'token show opened';
                else if(isMe && cell.p !== 0) t.className = 'token show stealth';
                else t.className = 'token';

                if(winLine && winLine.some(l => l.r === Math.floor(i/SIZE) && l.c === i%SIZE)) t.classList.add('win-token');
                
                let r = Math.floor(i/SIZE), c = i%SIZE;
                cells[i].style.background = (firstSelect && firstSelect.r===r && firstSelect.c===c) ? 'rgba(59, 130, 246, 0.2)' : 'var(--panel)';
            });
            document.getElementById('p1-ui').classList.toggle('active', currentPlayer===1);
            document.getElementById('p2-ui').classList.toggle('active', currentPlayer===2);
            document.getElementById('status-msg').innerText = winLine ? "GAME OVER" : `TURN: P${currentPlayer}`;
        }

        function startTimer() {
            timerId = setInterval(() => {
                if(winLine || isPassing) return;
                if(currentPlayer === 1) { if(p1Time > 0) p1Time--; else p1Byo--; if(p1Byo<0) endGame("P2 WIN (TIME)"); }
                else { if(p2Time > 0) p2Time--; else p2Byo--; if(p2Byo<0) endGame("P1 WIN (TIME)"); }
                const f = (t, b) => `${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}${t<=0?` (${b})`:''}`;
                document.getElementById('p1-t').innerText = f(p1Time, p1Byo);
                document.getElementById('p2-t').innerText = f(p2Time, p2Byo);
            }, 1000);
        }

        function endGame(m) {
            clearInterval(timerId);
            updateUI();
            db.ref('game_logs').push({winner: currentPlayer, history: moveHistory, date: Date.now()});
            setTimeout(() => { alert(m); location.reload(); }, 1200);
        }

        // --- Utils ---
        function resumeFromPass() { isPassing = false; document.getElementById('pass-overlay').style.display = 'none'; updateUI(); }
        function openSettings() { document.getElementById('settings-overlay').style.display = 'flex'; }
        function applySettings() {
            configMin = parseInt(document.getElementById('cfg-min').value) || 10;
            configByo = parseInt(document.getElementById('cfg-byo').value) || 30;
            initBoard(); closeOverlays();
        }
        function showOnlineSetup() { document.getElementById('online-overlay').style.display = 'flex'; }
        function connectOnline() {
            const kw = document.getElementById('match-kw').value.trim();
            if(!kw) return;
            dbRef = db.ref('rooms/' + kw);
            dbRef.get().then(snap => {
                myId = snap.exists() ? 2 : 1;
                dbRef.on('value', s => {
                    const d = s.val(); if(!d) return;
                    board = d.board; currentPlayer = d.turn;
                    if(d.win) endGame(`PLAYER ${currentPlayer===1?2:1} WIN!`);
                    updateUI();
                });
                setupGame('online');
            });
        }
        function syncOnline() { if(dbRef) dbRef.set({ board, turn: currentPlayer, win: !!winLine }); }
        function closeOverlays() { document.querySelectorAll('.overlay').forEach(o => { if(o.id !== 'menu-overlay') o.style.display = 'none'; }); }
        function handleReset() { if(confirm("RESET GAME?")) location.reload(); }
        function showLogs() {
            db.ref('game_logs').limitToLast(5).once('value', s => {
                let str = "RECENT RESULTS:\n";
                s.forEach(i => { str += `> P${i.val().winner} WON (${new Date(i.val().date).toLocaleDateString()})\n`; });
                alert(str || "No data yet.");
            });
        }
    </script>
</body>
</html>
