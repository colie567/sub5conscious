<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>潜在的五目 - 統合フル機能版</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root {
            --bg: #f8fafc; --panel: #ffffff; --text: #0f172a;
            --border: #cbd5e1; --accent: #3b82f6;
            --p1: #2563eb; --p2: #db2777;
        }
        .dark-mode {
            --bg: #000000; --panel: #111111; --text: #f8fafc;
            --border: #334155; --accent: #38bdf8;
        }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;
            transition: 0.3s;
        }

        /* --- UI Layers --- */
        #header { width: 100%; padding: 10px 0; background: var(--panel); border-bottom: 1px solid var(--border); z-index: 10; }
        .player-row { width: 90%; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .p-box { flex: 1; text-align: center; padding: 10px; opacity: 0.3; border-radius: 8px; border: 2px solid transparent; transition: 0.3s; }
        .p-box.active { opacity: 1; background: rgba(0,0,0,0.05); border-color: var(--accent); }
        #win-display { font-weight: bold; font-size: 1.2rem; color: var(--accent); height: 1.5em; text-align: center; }

        /* --- Board --- */
        #board-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        #board { display: grid; grid-template-columns: repeat(8, 1fr); width: 92vw; height: 92vw; max-width: 450px; background: var(--border); gap: 1px; border: 1px solid var(--border); }
        .cell { background: var(--panel); position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .token { width: 80%; height: 80%; border-radius: 50%; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0); pointer-events: none; }
        .token.show { transform: scale(1); }
        .token.opened { border: 3px solid #fff; box-shadow: 0 0 15px currentColor; transform: scale(1.05); opacity: 1 !important; }
        .token.stealth { opacity: 0.3; }

        /* --- Animations & Effects --- */
        @keyframes winBounce { 0%,100%{transform:scale(1.1) translateY(0);} 50%{transform:scale(1.4) translateY(-15px); filter:brightness(1.5); box-shadow: 0 0 30px currentColor;} }
        .win-token { animation: winBounce 0.6s ease-in-out infinite; z-index: 10; }
        .dimmed { opacity: 0.1 !important; transition: 1s; }
        .last-move { box-shadow: inset 0 0 0 4px var(--accent); z-index: 5; }

        /* --- Overlays --- */
        .overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .section { background: var(--panel); padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; margin-bottom: 12px; border: 1px solid var(--border); box-sizing: border-box; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        label { font-size: 0.7rem; font-weight: bold; color: var(--accent); margin-bottom: 5px; display: block; text-align: left; }

        /* --- Controls --- */
        #top-controls { position: fixed; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 2000; }
        .ctrl-btn { width: 44px; height: 44px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .ctrl-btn svg { width: 24px; height: 24px; fill: var(--text); }
        button { background: var(--panel); color: var(--text); border: 1px solid var(--border); padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button.active { background: var(--accent) !important; color: white !important; border: none; }
        
        #pass-overlay { background: #000; color: #fff; z-index: 4000; text-align: center; }
    </style>
</head>
<body>

    <div id="mode-selector" class="overlay" style="display: flex;">
        <h1 style="font-size: 2rem; margin-bottom: 30px;">潜在的五目</h1>
        <div class="section">
            <button onclick="startOffline()" style="width:100%; margin-bottom:10px; background:var(--accent); color:white; border:none;">OFFLINE 対戦</button>
            <button onclick="showOnlineSetup()" style="width:100%; background:var(--accent); color:white; border:none;">ONLINE 対戦</button>
        </div>
    </div>

    <div id="online-setup" class="overlay">
        <h2>合い言葉対戦</h2>
        <div class="section">
            <input type="text" id="match-keyword" placeholder="合い言葉を入力" style="width:100%; padding:15px; margin-bottom:15px; box-sizing:border-box; border-radius:8px; border:1px solid var(--border);">
            <button onclick="initOnlineConnection()" style="width:100%; background:var(--accent); color:white; border:none;">対戦開始</button>
        </div>
        <button onclick="location.reload()" style="background:none; border:none; opacity:0.5;">戻る</button>
    </div>

    <div id="pass-overlay" class="overlay">
        <h2 id="pass-msg">PLAYER 2 の番です</h2>
        <h1 style="font-size:2rem; margin: 20px 0;">端末を渡してください</h1>
        <p style="opacity:0.7; margin-bottom:30px;">（青枠があなたの置いた駒です）</p>
        <button onclick="hidePassOverlay()" style="padding:15px 50px; background:white; color:black; font-weight:bold; border-radius:50px; border:none;">受け取りました</button>
    </div>

    <div id="game-end-overlay" class="overlay">
        <h1 id="end-status-msg" style="color:var(--accent);">勝利！</h1>
        <div class="section">
            <button onclick="confirmRestart()" style="width:100%; background:#22c55e; color:white; border:none; margin-bottom:10px;">再戦 (REMATCH)</button>
            <button onclick="location.reload()" style="width:100%; background:#ef4444; color:white; border:none;">終了 (EXIT)</button>
        </div>
    </div>

    <div id="top-controls">
        <div class="ctrl-btn" onclick="location.reload()" title="Home"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div>
        <div id="btn-reset" class="ctrl-btn" onclick="handleResetClick()">
            <svg id="svg-reset" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            <svg id="svg-retire" viewBox="0 0 24 24" style="display:none;"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z"/></svg>
        </div>
        <div class="ctrl-btn" onclick="toggleMenu()" title="Settings"><span>≡</span></div>
    </div>

    <div id="header">
        <div id="win-display"></div>
        <div class="player-row">
            <div id="p1-ui" class="p-box active" style="color:var(--p1)">
                <div>P1</div>
                <div class="tm-group"><span id="p1-byo" style="font-size:0.7rem; color:red; height:1.2em; display:block;"></span><div id="p1-t" style="font-size:1.4rem; font-weight:bold;">10:00</div></div>
            </div>
            <div id="p2-ui" class="p-box" style="color:var(--p2)">
                <div>P2</div>
                <div class="tm-group"><span id="p2-byo" style="font-size:0.7rem; color:red; height:1.2em; display:block;"></span><div id="p2-t" style="font-size:1.4rem; font-weight:bold;">10:00</div></div>
            </div>
        </div>
    </div>

    <div id="board-area"><div id="board"></div></div>

    <div id="settings-modal" class="overlay" style="justify-content: flex-start; padding-top: 80px;">
        <h2>OPTIONS</h2>
        <div class="section"><label>Timer</label><div class="grid-2"><button id="tm-on" class="active" onclick="toggleTimer(true)">ON</button><button id="tm-off" onclick="toggleTimer(false)">OFF</button></div></div>
        <div class="section"><label>Player Colors</label><div class="grid-2">
            <input type="color" id="p1-c" value="#2563eb" onchange="updateColors()">
            <input type="color" id="p2-c" value="#db2777" onchange="updateColors()">
        </div></div>
        <div class="section"><label>Display Mode</label><div class="grid-2"><button id="m-light" class="active" onclick="setMode('light')">LIGHT</button><button id="m-dark" onclick="setMode('dark')">DARK</button></div></div>
        <button onclick="toggleMenu()" style="border:none; margin-top:20px; opacity:0.6; background:none;">CLOSE</button>
    </div>

    <script>
        // Firebase Config反映済み
        const firebaseConfig = {
            apiKey: "AIzaSyAIkCvmJVZE9qzeAPFTIEijsuZ_HGRiUlA",
            authDomain: "sub5conscious.firebaseapp.com",
            projectId: "sub5conscious",
            databaseURL: "https://sub5conscious-default-rtdb.firebaseio.com",
            storageBucket: "sub5conscious.firebasestorage.app",
            messagingSenderId: "774659474330",
            appId: "1:774659474330:web:d1ff3843a96f6e6001b023"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let dbRef = null;

        let SIZE = 8, currentPlayer = 1, boardData = [], winLine = [], lastMoves = [];
        let timerInterval, p1Time, p2Time, p1Byo, p2Byo, configMin = 10, configByo = 30;
        let timerEnabled = true, gameMode = 'offline', myPlayerId = 1, isWaitingPass = false, firstPick = null;

        function startOffline() { gameMode = 'offline'; document.getElementById('mode-selector').style.display = 'none'; init(); }
        function showOnlineSetup() { document.getElementById('online-setup').style.display = 'flex'; }
        
        function initOnlineConnection() {
            const kw = document.getElementById('match-keyword').value.trim();
            if(!kw) return;
            dbRef = db.ref('rooms/' + kw);
            dbRef.get().then(snap => {
                myPlayerId = snap.exists() ? 2 : 1;
                gameMode = 'online';
                document.getElementById('online-setup').style.display = 'none';
                document.getElementById('mode-selector').style.display = 'none';
                document.getElementById('svg-reset').style.display = 'none';
                document.getElementById('svg-retire').style.display = 'block';
                if(myPlayerId===1) init();
                startOnlineListener();
            });
        }

        function init() {
            clearInterval(timerInterval);
            const b = document.getElementById('board'); b.innerHTML = ''; 
            winLine = []; firstPick = null; lastMoves = [];
            document.getElementById('win-display').innerText = '';
            boardData = Array.from({length:SIZE},()=>Array(SIZE).fill(null).map(()=>({owner:0, opened:false})));
            for(let r=0; r<SIZE; r++) {
                for(let c=0; c<SIZE; c++) {
                    let cell = document.createElement('div'); cell.className = 'cell'; cell.id = `c-${r}-${c}`;
                    cell.onclick = () => handleInput(r, c);
                    let t = document.createElement('div'); t.className = 'token'; cell.appendChild(t); b.appendChild(cell);
                }
            }
            p1Time = configMin * 60; p2Time = configMin * 60; p1Byo = configByo; p2Byo = configByo;
            if(timerEnabled) startTimerLoop();
            if(gameMode==='online') sync();
            updateView();
        }

        function handleInput(r, c) {
            if(winLine.length > 0 || isWaitingPass || boardData[r][c].opened) return;
            if(gameMode==='online' && currentPlayer !== myPlayerId) return;
            
            if(!firstPick) {
                firstPick = {r,c};
            } else {
                let dr = Math.abs(r-firstPick.r), dc = Math.abs(c-firstPick.c);
                if(dr===0 && dc===0) commit([{r, c, open: true}]);
                else if(dr+dc===1) commit([{r: firstPick.r, c: firstPick.c, open: false}, {r: r, c: c, open: false}]);
                else firstPick = {r,c};
            }
            updateView();
        }

        function commit(moves) {
            lastMoves = moves;
            moves.forEach(m => {
                let cell = boardData[m.r][m.c];
                if(cell.owner !== 0 || m.open) cell.opened = true;
                cell.owner = currentPlayer;
            });

            if(checkWin(currentPlayer)) {
                endGame(`PLAYER ${currentPlayer} の勝利！`);
                return;
            }

            if(gameMode === 'offline') {
                isWaitingPass = true;
                document.getElementById('pass-msg').innerText = `次は PLAYER ${currentPlayer===1?2:1} の番です`;
                document.getElementById('pass-overlay').style.display = 'flex';
                currentPlayer = currentPlayer === 1 ? 2 : 1;
            } else {
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                sync();
            }
            firstPick = null;
            updateView();
        }

        function checkWin(p) {
            const checkDir = (r,c,dr,dc) => {
                let line = [];
                for(let i=0; i<5; i++) {
                    let nr=r+dr*i, nc=c+dc*i;
                    if(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && boardData[nr][nc].owner===p && boardData[nr][nc].opened) line.push({r:nr,c:nc});
                    else break;
                }
                if(line.length===5) { winLine = line; return true; }
                return false;
            };
            for(let r=0; r<SIZE; r++) {
                for(let c=0; c<SIZE; c++) {
                    if(boardData[r][c].owner===p && boardData[r][c].opened) {
                        if(checkDir(r,c,1,0) || checkDir(r,c,0,1) || checkDir(r,c,1,1) || checkDir(r,c,1,-1)) return true;
                    }
                }
            }
            return false;
        }

        function endGame(msg) {
            clearInterval(timerInterval);
            document.getElementById('win-display').innerText = msg;
            document.getElementById('end-status-msg').innerText = msg;
            if(gameMode==='online') sync();
            setTimeout(() => {
                document.getElementById('game-end-overlay').style.display = 'flex';
            }, 1500);
            updateView();
        }

        function handleResetClick() {
            if(gameMode === 'online') {
                if(confirm("リタイアしますか？")) dbRef.update({ retiredBy: myPlayerId });
            } else {
                if(confirm("盤面をリセットしますか？")) init();
            }
        }

        function startOnlineListener() {
            dbRef.on('value', snap => {
                const data = snap.val();
                if(!data) return;
                if(data.retiredBy) { endGame(`P${data.retiredBy} がリタイアしました`); return; }
                boardData = data.board; currentPlayer = data.turn;
                if(data.winLine) endGame(`PLAYER ${currentPlayer===1?2:1} の勝利！`);
                updateView();
            });
        }

        function sync() { if(dbRef) dbRef.set({ board: boardData, turn: currentPlayer, winLine: winLine.length>0 }); }

        function updateView() {
            const cells = document.querySelectorAll('.cell');
            boardData.flat().forEach((d, i) => {
                let r=Math.floor(i/SIZE), c=i%SIZE, t=cells[i].querySelector('.token');
                if(!t) return;
                t.style.backgroundColor = d.owner===1 ? 'var(--p1)':'var(--p2)';
                
                let isMe = (gameMode==='offline' && d.owner===(isWaitingPass ? (currentPlayer===1?2:1) : currentPlayer)) || (gameMode==='online' && d.owner===myPlayerId);
                if(d.opened) t.className = 'token show opened';
                else if(isMe && d.owner!==0) t.className = 'token show stealth';
                else t.className = 'token';

                if(winLine.length > 0) {
                    if(winLine.some(l=>l.r===r && l.c===c)) t.classList.add('win-token');
                    else t.classList.add('dimmed');
                }
                
                // ハイライト表示
                cells[i].classList.remove('last-move');
                if(lastMoves.some(m=>m.r===r && m.c===c)) cells[i].classList.add('last-move');
                cells[i].style.background = (firstPick && firstPick.r===r && firstPick.c===c) ? 'rgba(59, 130, 246, 0.2)' : 'var(--panel)';
            });
            document.getElementById('p1-ui').classList.toggle('active', currentPlayer===1);
            document.getElementById('p2-ui').classList.toggle('active', currentPlayer===2);
        }

        function startTimerLoop() {
            timerInterval = setInterval(() => {
                if(winLine.length > 0 || isWaitingPass || !timerEnabled) return;
                if(currentPlayer === 1) { if(p1Time > 0) p1Time--; else if(p1Byo > 0) p1Byo--; else endGame("P2 WIN BY TIME"); }
                else { if(p2Time > 0) p2Time--; else if(p2Byo > 0) p2Byo--; else endGame("P1 WIN BY TIME"); }
                const f = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                document.getElementById('p1-t').innerText = p1Time > 0 ? f(p1Time) : p1Byo;
                document.getElementById('p1-byo').innerText = p1Time <= 0 ? "BYOYOMI" : "";
                document.getElementById('p2-t').innerText = p2Time > 0 ? f(p2Time) : p2Byo;
                document.getElementById('p2-byo').innerText = p2Time <= 0 ? "BYOYOMI" : "";
            }, 1000);
        }

        function hidePassOverlay() { isWaitingPass = false; lastMoves = []; document.getElementById('pass-overlay').style.display = 'none'; updateView(); }
        function toggleMenu() { const s=document.getElementById('settings-modal'); s.style.display=(s.style.display==='flex')?'none':'flex'; }
        function toggleTimer(v) { timerEnabled=v; document.getElementById('tm-on').classList.toggle('active', v); document.getElementById('tm-off').classList.toggle('active', !v); }
        function updateColors() { document.documentElement.style.setProperty('--p1', document.getElementById('p1-c').value); document.documentElement.style.setProperty('--p2', document.getElementById('p2-c').value); updateView(); }
        function setMode(m) { document.body.className = (m==='dark'?'dark-mode':''); document.getElementById('m-light').classList.toggle('active',m==='light'); document.getElementById('m-dark').classList.toggle('active',m==='dark');}
        function confirmRestart() { 
            document.getElementById('game-end-overlay').style.display='none'; 
            if(gameMode==='online') dbRef.set(null); 
            location.reload(); 
        }
    </script>
</body>
</html>
